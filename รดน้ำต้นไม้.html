<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My DIY IoT Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #222; color: white; padding: 20px; }
        .card { background: #333; max-width: 400px; margin: auto; padding: 20px; border-radius: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        h1 { color: #00ff7f; }
        .value { font-size: 3rem; font-weight: bold; margin: 20px 0; }
        .btn { padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 8px; cursor: pointer; margin: 5px; width: 100px; }
        .btn-on { background-color: #ff4d4d; color: white; }
        .btn-off { background-color: #4caf50; color: white; }
        .btn-auto { background-color: #2196F3; color: white; width: 210px; }
        #status { color: gray; font-size: 0.8rem; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h1>üå± ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥ (DIY)</h1>
    <p>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
    <div id="soilVal" class="value">-- %</div>
    <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡πä‡∏°: <span id="pumpStatus" style="font-weight:bold;">Waiting...</span></p>
    
    <hr style="border-color:#555;">
    
    <p>‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (Manual)</p>
    <button class="btn btn-on" onclick="sendCommand('ON')">‡πÄ‡∏õ‡∏¥‡∏î‡∏ô‡πâ‡∏≥</button>
    <button class="btn btn-off" onclick="sendCommand('OFF')">‡∏õ‡∏¥‡∏î‡∏ô‡πâ‡∏≥</button>
    <br>
    <button class="btn btn-auto" onclick="sendCommand('AUTO')">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î Auto</button>
    
    <div id="status">Connecting to MQTT Broker...</div>
</div>

<script>
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô ESP32
    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Port WebSockets (8000) ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 1883
    const broker = "broker.hivemq.com";
    const port = 8000; 
    const topicSoil = "miniproject/soil_020";
    const topicPump = "miniproject/pump_020";
    const topicBtn  = "miniproject/btn_020";

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Client ID ‡∏™‡∏∏‡πà‡∏°
    const clientID = "WebClient-" + parseInt(Math.random() * 100);
    const client = new Paho.MQTT.Client(broker, port, clientID);

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    function onConnect() {
        console.log("Connected to MQTT");
        document.getElementById("status").innerText = "üü¢ System Online";
        document.getElementById("status").style.color = "#00ff7f";
        
        // ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        client.subscribe(topicSoil);
        client.subscribe(topicPump);
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏∏‡∏î
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Connection Lost: " + responseObject.errorMessage);
            document.getElementById("status").innerText = "üî¥ Offline";
            document.getElementById("status").style.color = "red";
        }
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å ESP32
    function onMessageArrived(message) {
        console.log("Topic: " + message.destinationName + " Msg: " + message.payloadString);
        
        if (message.destinationName === topicSoil) {
            document.getElementById("soilVal").innerText = message.payloadString + " %";
        } else if (message.destinationName === topicPump) {
            let state = message.payloadString;
            let el = document.getElementById("pumpStatus");
            el.innerText = state;
            el.style.color = (state === "ON") ? "#ff4d4d" : "#4caf50";
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°)
    function sendCommand(cmd) {
        message = new Paho.MQTT.Message(cmd);
        message.destinationName = topicBtn;
        client.send(message);
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    client.connect({onSuccess:onConnect});
</script>

</body>
</html>